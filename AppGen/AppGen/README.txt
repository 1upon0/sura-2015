Use Appgen.m to remove the highlight and the shadow pixels from the image.
Use any standard inpainting technique to inpaint the image
Use Appgen2.m to obtain the diffuse image.